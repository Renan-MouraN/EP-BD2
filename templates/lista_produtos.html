<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossos Produtos - PataCerta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #6C63FF;
            --secondary: #5850D8;
            --dark: #2E3056;
            --light: #F4F6FC;
            --accent: #FF6B6B;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-icon {
            font-size: 28px;
            margin-right: 8px;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 10px;
            align-items: center;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 8px 12px;
            display: flex;
            align-items: center;
        }
        
        .nav-links a:hover:not(.btn) {
            color: var(--primary);
        }

        .hidden {
            display: none !important;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.3s, opacity 0.3s;
        }
        
        .btn:hover {
            background-color: #5850D8;
        }
        
        .btn:disabled {
            background-color: #a5a2f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary { background-color: var(--secondary); }
        .btn-danger { background-color: var(--accent); }
        .btn-outline { background-color: transparent; border: 2px solid #ccc; color: var(--dark); }
        .btn-outline:hover { background-color: var(--light); }

        .page-header {
            text-align: center;
            padding: 40px 20px;
        }
        
        .page-header h1 {
            font-size: 42px;
            color: var(--dark);
        }
        
        .page-header p {
            font-size: 18px;
            color: #555;
            max-width: 600px;
            margin: 10px auto 0;
        }

        .admin-controls {
            background-color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Admin Table View */
        .admin-view table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .admin-view th, .admin-view td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .admin-view th {
            background-color: var(--primary);
            color: white;
        }
        .admin-view tr:nth-child(even) { background-color: #f8f9fa; }
        .admin-view .action-buttons { display: flex; gap: 10px; }

        /* Public Grid View */
        .public-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .product-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .product-img { height: 220px; background-color: #eee; }
        .product-img img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 20px; text-align: left; display: flex; flex-direction: column; flex-grow: 1; }
        .product-info h3 { font-size: 20px; color: var(--dark); margin-bottom: 5px; }
        .product-category { color: #777; font-size: 14px; margin-bottom: 15px; }
        
        .product-bottom { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: auto; 
            padding-top: 15px; 
        }
        .product-price { 
            font-size: 22px; 
            font-weight: 700; 
            color: var(--primary);
            flex-shrink: 0;
            margin-right: 10px;
        }
        .buy-controls { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .quantity-input { 
            width: 60px; 
            padding: 9px; 
            text-align: center; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px;
        }
        .quantity-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Filter Form */
        .filter-section {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }
        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }
        .filter-form select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            width: 100%;
        }
        .filter-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        /* Pagination Styles - ATUALIZADO */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
            padding-bottom: 20px;
            gap: 8px;
        }
        .pagination button, .pagination span {
            background-color: white;
            border: 1px solid #ddd;
            color: var(--dark);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }
        .pagination span {
            cursor: default;
            border-color: transparent;
            background-color: transparent;
        }
        .pagination button:hover:not(:disabled) {
            background-color: var(--light);
            border-color: #ccc;
        }
        .pagination button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: bold;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 60px 0 20px;
            margin-top: 60px;
        }
        
        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .footer-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        
        .footer-section ul li {
            margin-bottom: 10px;
        }
        
        .footer-section a {
            text-decoration: none;
            color: #ddd;
            transition: color 0.3s;
        }
        
        .footer-section a:hover {
            color: var(--primary);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #555;
            color: #bbb;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo"><i class="logo-icon">üêæ</i> Pata<span>Certa</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">In√≠cio</a></li>
                    <li><a href="lista_animais.html">Animais</a></li>
                    <li><a href="lista_produtos.html">Produtos</a></li>
                    <li><a href="lista_servicos.html">Servi√ßos</a></li>
                    <li id="nav-admin" class="hidden"><a href="admin.html" class="btn">Painel Admin</a></li>
                    <li id="nav-logged-out" class="hidden"><a href="login.html" class="btn btn-outline">Login</a></li>
                    <li id="nav-logged-out-2" class="hidden"><a href="cadastro.html" class="btn">Cadastre-se</a></li>
                    <li id="nav-logged-in" class="hidden"><a href="meu_perfil.html">Meu Perfil</a></li>
                    <li id="nav-logged-in-2" class="hidden"><a href="#" id="logout-btn" class="btn btn-secondary">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h1 id="page-title">Nossos Produtos</h1>
            <p id="page-subtitle">Tudo o que o seu pet precisa para uma vida feliz e saud√°vel.</p>
        </div>

        <!-- Filter Section -->
        <section class="filter-section">
             <form class="filter-form" id="filter-form">
                <select name="categoria" id="categoria-select">
                    <option value="">Todas as Categorias</option>
                    <!-- Options will be filled by JS -->
                </select>
                <div class="filter-buttons">
                    <button type="submit" class="btn">Buscar</button>
                    <button type="button" id="clear-filters-btn" class="btn btn-outline">Limpar Filtros</button>
                </div>
            </form>
        </section>

        <!-- Admin Controls -->
        <div id="admin-controls" class="admin-controls hidden">
            <h2>Gerenciamento de Produtos</h2>
            <a href="form_produto.html" class="btn btn-primary">+ Adicionar Produto</a>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="admin-view hidden">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>

        <!-- Public View -->
        <div id="public-view" class="public-view">
            <!-- Product cards will be inserted here -->
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-container" class="pagination">
            <!-- Pagination buttons will be inserted here -->
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-container">
                <div class="footer-section"><h3>PataCerta</h3><p>Conectando pets a novos lares amorosos.</p></div>
                <div class="footer-section"><h3>Links √öteis</h3><ul><li><a href="index.html">In√≠cio</a></li><li><a href="#">Sobre N√≥s</a></li></ul></div>
                <div class="footer-section"><h3>Contato</h3><ul><li>üìß contato@patacerta.com</li><li>üìû (11) 99999-9999</li></ul></div>
            </div>
            <div class="footer-bottom"><p>&copy; 2025 PataCerta - Todos os direitos reservados</p></div>
        </footer>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let currentUser = null;
        let allProducts = [];
        let currentFilteredProducts = [];
        let currentPage = 1;
        const productsPerPage = 12;

        function updateUIForLoginState() {
            const navAdmin = document.getElementById('nav-admin');
            const navProfile = document.getElementById('nav-logged-in');
            const navLogout = document.getElementById('nav-logged-in-2');
            const navLoggedOut = document.querySelectorAll('#nav-logged-out, #nav-logged-out-2');
            
            const userData = JSON.parse(localStorage.getItem('patacerta_user'));
            currentUser = userData;

            navAdmin.classList.add('hidden');
            navProfile.classList.add('hidden');
            navLogout.classList.add('hidden');
            navLoggedOut.forEach(el => el.classList.add('hidden'));

            if (userData && userData.nome) {
                navLogout.classList.remove('hidden');
                if (userData.is_admin) {
                    navAdmin.classList.remove('hidden');
                } else {
                    navProfile.classList.remove('hidden');
                }
            } else {
                navLoggedOut.forEach(el => el.classList.remove('hidden'));
            }
        }

        function handleLogout() {
            localStorage.removeItem('patacerta_user');
            alert("Voc√™ saiu da sua conta.");
            window.location.reload();
        }

        function renderPublicView(products) {
            const grid = document.getElementById('public-view');
            grid.innerHTML = '';
            if (products.length === 0) {
                grid.innerHTML = '<p>Nenhum produto encontrado com os filtros selecionados.</p>';
                return;
            }
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                const fallbackImageUrl = `https://placehold.co/400x300/9e96f2/FFFFFF?text=${encodeURIComponent(product.nome)}`;
                const primaryImageUrl = product.imagem || fallbackImageUrl;

                card.innerHTML = `
                    <div class="product-img">
                        <img src="${primaryImageUrl}" alt="${product.nome}" onerror="this.onerror=null;this.src='${fallbackImageUrl}';">
                    </div>
                    <div class="product-info">
                        <span class="product-category">${product.categoria || 'Geral'}</span>
                        <h3>${product.nome}</h3>
                        <div class="product-bottom">
                            <span class="product-price">R$ ${parseFloat(product.preco).toFixed(2)}</span>
                            <div class="buy-controls">
                                <input type="number" class="quantity-input" value="1" min="1" max="99" data-product-id="${product.id_produto}" aria-label="Quantidade">
                                <button class="btn btn-comprar" data-id="${product.id_produto}" data-price="${product.preco}">Comprar</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderAdminView(products) {
            const tableBody = document.getElementById('admin-table-body');
            tableBody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id_produto}</td>
                    <td>${product.nome}</td>
                    <td>${product.categoria}</td>
                    <td>R$ ${parseFloat(product.preco).toFixed(2)}</td>
                    <td>${product.estoque}</td>
                    <td class="action-buttons">
                        <a href="form_produto.html?id=${product.id_produto}" class="btn btn-secondary">Editar</a>
                        <button onclick="deleteProduct(${product.id_produto})" class="btn btn-danger">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function renderCurrentPage() {
            const isAdmin = currentUser && currentUser.is_admin;
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const productsForPage = currentFilteredProducts.slice(startIndex, endIndex);

            if (isAdmin) {
                renderAdminView(currentFilteredProducts);
            } else {
                renderPublicView(productsForPage);
            }
        }

        // --- FUN√á√ÉO DE PAGINA√á√ÉO ATUALIZADA ---
        function setupPagination() {
            const paginationContainer = document.getElementById('pagination-container');
            paginationContainer.innerHTML = '';
            const isAdmin = currentUser && currentUser.is_admin;
            if (isAdmin) return; 

            const pageCount = Math.ceil(currentFilteredProducts.length / productsPerPage);
            if (pageCount <= 1) return;

            const createButton = (page, text = page) => {
                const button = document.createElement('button');
                button.textContent = text;
                if (page === currentPage) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => {
                    currentPage = page;
                    renderCurrentPage();
                    setupPagination();
                });
                return button;
            };

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCurrentPage();
                    setupPagination();
                }
            });
            paginationContainer.appendChild(prevButton);

            const maxPagesToShow = 5;
            let startPage, endPage;

            if (pageCount <= maxPagesToShow) {
                startPage = 1;
                endPage = pageCount;
            } else {
                const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
                const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
                if (currentPage <= maxPagesBeforeCurrent) {
                    startPage = 1;
                    endPage = maxPagesToShow;
                } else if (currentPage + maxPagesAfterCurrent >= pageCount) {
                    startPage = pageCount - maxPagesToShow + 1;
                    endPage = pageCount;
                } else {
                    startPage = currentPage - maxPagesBeforeCurrent;
                    endPage = currentPage + maxPagesAfterCurrent;
                }
            }

            if (startPage > 1) {
                paginationContainer.appendChild(createButton(1));
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    paginationContainer.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationContainer.appendChild(createButton(i));
            }

            if (endPage < pageCount) {
                if (endPage < pageCount - 1) {
                     const dots = document.createElement('span');
                    dots.textContent = '...';
                    paginationContainer.appendChild(dots);
                }
                paginationContainer.appendChild(createButton(pageCount));
            }

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Pr√≥ximo';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    renderCurrentPage();
                    setupPagination();
                }
            });
            paginationContainer.appendChild(nextButton);
        }

        function displayResults(products) {
            currentFilteredProducts = products;
            currentPage = 1;
            renderCurrentPage();
            setupPagination();
        }

        async function deleteProduct(productId) {
            if (!currentUser || !currentUser.is_admin) return alert("Apenas administradores podem excluir produtos.");
            if (!confirm(`Tem certeza que deseja excluir o produto com ID ${productId}?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/produtos/${productId}?userId=${currentUser.id_usuario}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail);
                alert("Produto exclu√≠do com sucesso!");
                initializeApp();
            } catch (error) {
                alert(`Erro ao excluir: ${error.message}`);
            }
        }

        function populateCategoryFilter(products) {
            const categories = [...new Set(products.map(p => p.categoria).filter(Boolean))];
            const select = document.getElementById('categoria-select');
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        function handleFilterSubmit(event) {
            event.preventDefault();
            const selectedCategory = document.getElementById('categoria-select').value;
            let filteredProducts = allProducts;

            if (selectedCategory) {
                filteredProducts = allProducts.filter(p => p.categoria === selectedCategory);
            }
            
            document.getElementById('page-title').textContent = selectedCategory ? `Mostrando: ${selectedCategory}` : 'Todos os Produtos';
            displayResults(filteredProducts);
        }

        function clearFilters() {
            document.getElementById('filter-form').reset();
            document.getElementById('page-title').textContent = 'Nossos Produtos';
            displayResults(allProducts);
        }
        
        async function handleBuyClick(event) {
            if (!event.target.classList.contains('btn-comprar')) {
                return;
            }
            
            event.preventDefault();

            const button = event.target;
            const productId = button.dataset.id;
            const productPrice = parseFloat(button.dataset.price);
            
            // Get the quantity from the input field associated with the clicked button
            const quantityInput = button.parentElement.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput.value, 10);

            if (isNaN(quantity) || quantity < 1) {
                alert("Por favor, insira uma quantidade v√°lida (maior que zero).");
                return;
            }

            if (!currentUser || !currentUser.id_usuario) {
                alert("Por favor, fa√ßa login para realizar uma compra.");
                window.location.href = 'login.html';
                return;
            }
            
            const userId = currentUser.id_usuario;
            console.log(`Iniciando compra para o usu√°rio ID: ${userId}, Produto ID: ${productId}, Quantidade: ${quantity}`);

            button.disabled = true;
            button.textContent = 'Processando...';

            try {
                const totalValue = productPrice * quantity;

                const pedidoData = {
                    id_usuario: userId,
                    valor_total: totalValue,
                    status: 'pago' 
                };

                const urlPedido = `${API_BASE_URL}/pedidos/?userId=${userId}`;
                const pedidoResponse = await fetch(urlPedido, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pedidoData)
                });

                const pedidoResultText = await pedidoResponse.text();

                if (!pedidoResponse.ok) {
                    let errorDetail = 'N√£o foi poss√≠vel criar o pedido.';
                    try { errorDetail = JSON.parse(pedidoResultText).detail || errorDetail; } catch (e) {}
                    throw new Error(errorDetail);
                }

                const novoPedido = JSON.parse(pedidoResultText);
                const pedidoId = novoPedido.id_pedido;
                console.log('Pedido criado com sucesso. ID:', pedidoId);

                const itemData = {
                    id_pedido: pedidoId,
                    id_produto: parseInt(productId),
                    quantidade: quantity,
                    preco_unitario: productPrice
                };

                const urlItem = `${API_BASE_URL}/itens_pedido/?userId=${userId}`;
                const itemResponse = await fetch(urlItem, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });

                const itemResultText = await itemResponse.text();

                if (!itemResponse.ok) {
                    let errorDetail = 'N√£o foi poss√≠vel adicionar o item ao pedido.';
                     try { errorDetail = JSON.parse(itemResultText).detail || errorDetail; } catch (e) {}
                    throw new Error(errorDetail);
                }

                console.log('Item adicionado com sucesso ao pedido.');
                alert(`Compra de ${quantity} unidade(s) realizada com sucesso! ID do seu pedido: ${pedidoId}`);

            } catch (error) {
                console.error('Erro detalhado na compra:', error);
                alert(`Erro na compra: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Comprar';
            }
        }

        async function initializeApp() {
            updateUIForLoginState();
            
            const isAdmin = currentUser && currentUser.is_admin;
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-view').classList.toggle('hidden', !isAdmin);
            document.getElementById('public-view').classList.toggle('hidden', isAdmin);
            
            const targetView = isAdmin ? document.getElementById('admin-table-body') : document.getElementById('public-view');
            targetView.innerHTML = isAdmin ? '<tr><td colspan="6" style="text-align:center;">A carregar...</td></tr>' : '<p>A carregar...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/produtos/?limit=200`);
                if (!response.ok) throw new Error("N√£o foi poss√≠vel carregar os dados dos produtos.");
                allProducts = await response.json();
                
                populateCategoryFilter(allProducts);
                displayResults(allProducts);

            } catch (error) {
                targetView.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            document.getElementById('filter-form').addEventListener('submit', handleFilterSubmit);
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            document.getElementById('public-view').addEventListener('click', handleBuyClick);
        });
    </script>
</body>
</html>
